from wrapper_sistema_completo_dos_bombas import SolarLoop, ProcessLoop, export_to_csv, clear_data_log
import time
import threading
from datetime import datetime
 
solar_loop = SolarLoop(verbose=True)
process_loop = ProcessLoop(verbose=True)
 
print("[Setup] Cerrando válvulas 1 y 2 para comenzar desde cero...")
solar_loop.cerrar_valvula(1)
solar_loop.cerrar_valvula(2)
time.sleep(1)
 
def log_all_data():
    now = datetime.now()
    timestamp = now.strftime('%Y-%m-%d %H:%M:%S')
    solar_loop.append_to_data_log(timestamp)
    process_loop.append_to_data_log(timestamp)
 
 
print("Iniciando test del SolarLoop y ProcessLoop...")
 
solar_loop.stop()
process_loop.stop()
clear_data_log()

solar_loop.calentadordos.get_temperaturas()
time.sleep(0.5)
print(f"[DEBUG] Temp7 vor Logging: {solar_loop.calentadordos.temp7}", flush=True)

solar_loop.potencia_calentador(100)
log_all_data()
 
 
solar_loop.abrir_valvula(1)
log_all_data()
 
 
print("Esperando 10 segundos...")
time.sleep(10)
 
solar_loop.potencia_bomba1(90)
log_all_data()
 
process_loop.potencia_bomba2(90)
log_all_data()
 
process_loop.potencia_dissipador(0)
log_all_data()
 
 
print("Haciendo mediciones")
 
# Funktionen, um beide Tests gleichzeitig zu starten
def solar_test():
    solar_loop.run_synchronized_test(process_loop, duration_minutes=1, interval_seconds=20)        # testeando solar loop para x minutos, colectando datos cada y segundos
 
def process_test():
    pass
 
# Threads mit klaren Namen
solar_thread = threading.Thread(target=solar_test)
process_thread = threading.Thread(target=process_test)
 
def control_bomba2_temporal():
     time.sleep(3600)  # 1 Stunde warten
     process_loop.potencia_bomba2(0)
     print("Bomba2 activada al 100%.")
 
def control_dissipador_temporal():
     time.sleep(3600)  # 1 Stunde warten
     process_loop.potencia_dissipador(0)
     print("Dissipador activado al 100%.")
 
#threading.Thread(target=control_bomba2_temporal).start()
#threading.Thread(target=control_dissipador_temporal).start()
 
 
solar_thread.start()
process_thread.start()
 
solar_thread.join()
process_thread.join()
 
solar_loop.potencia_bomba1(0)
solar_loop.potencia_calentador(0)
process_loop.potencia_bomba2(0)
process_loop.potencia_dissipador(0)
log_all_data()
 
 
csv_file = export_to_csv()
print(f"¡Terminado! Archivo Excel: {csv_file}")