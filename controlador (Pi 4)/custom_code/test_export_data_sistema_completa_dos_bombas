from wrapper_sistema_completo_dos_bombas import SolarLoop, ProcessLoop, export_to_csv, clear_data_log
import time
import threading
from datetime import datetime
 
solar_loop = SolarLoop(verbose=True)
process_loop = ProcessLoop(verbose=True)
 
print("[Setup] Close valves 1 y 2 in order to begin from zero...")
solar_loop.close_valve(1)
solar_loop.close_valve(2)
time.sleep(1)
 
def log_all_data():
    now = datetime.now()
    timestamp = now.strftime('%Y-%m-%d %H:%M:%S')
    solar_loop.append_to_data_log(timestamp)
    process_loop.append_to_data_log(timestamp)
 
 
print("Beginning test with SolarLoop and ProcessLoop...")
 
solar_loop.stop()
process_loop.stop()
clear_data_log()

solar_loop.heater2.get_temperatures()
time.sleep(0.5)

solar_loop.tank.get_temperatures()  
time.sleep(0.5)
#print(f"[DEBUG Tank] bottom={solar_loop.tank.temp_bottom:.2f}, top={solar_loop.tank.temp_top:.2f}")


solar_loop.power_heater1(100)
log_all_data()

solar_loop.power_heater2(100)
log_all_data() 
 
solar_loop.open_valve(1)
log_all_data()
 
 
print("Waiting 10 seconds...")
time.sleep(10)
 
solar_loop.power_pump1(90)
log_all_data()
 
process_loop.power_pump2(90)
log_all_data()
 
process_loop.power_radiator1(90)
log_all_data()
 
 
print("Making measurements")
 
# Functions in order to start both processes at the same time
def solar_test():
    solar_loop.run_synchronized_test(process_loop, duration_minutes=1, interval_seconds=20)        # testeando solar loop para x minutos, colectando datos cada y segundos
 
def process_test():
    pass
 
# Threads with specific names
solar_thread = threading.Thread(target=solar_test)
process_thread = threading.Thread(target=process_test)
 
def control_pump2_temporal():
     time.sleep(3600)  # 1 Stunde warten
     process_loop.power_pump2(0)
     print("Pump2 activated at 100%.")
 
def control_radiator1_temporal():
     time.sleep(3600)  # 1 Stunde warten
     process_loop.power_radiator1(0)
     print("Radiator1 activated at 100%.")
 
#threading.Thread(target=control_bomba2_temporal).start()
#threading.Thread(target=control_dissipador_temporal).start()
 
 
solar_thread.start()
process_thread.start()
 
solar_thread.join()
process_thread.join()
 
solar_loop.power_pump1(0)
solar_loop.power_heater1(0)
solar_loop.power_heater2(0)
process_loop.power_pump2(0)
process_loop.power_radiator1(0)
log_all_data()
 
 
csv_file = export_to_csv()
print(f"Finished! Excel File: {csv_file}")